<dom-module id="main-page">
	<template>
		<style>
			#root {
				width: 100vw;
				height: 100vh;
			}
		</style>
		
		<div id="root"></div>
		
  	<main-panel counter="[[counter]]" id="p"></main-panel>
  </template>

  <script>
    class MainPage extends Polymer.Element {
      static get is() { return 'main-page'; }
      
      static get properties() { return {
      	counter: {
					type: Number,
					notify: true,
					value: 0
				}	
      }}
      
      inc() {
      	this.set('counter', l(this.counter + 1));
      }
      
      ready() {
      	super.ready();
      	
      	var Surface = Samsara.DOM.Surface;
				var Context = Samsara.DOM.Context;
				var Transform = Samsara.Core.Transform;
				var Transitionable = Samsara.Core.Transitionable;
				var MouseInput = Samsara.Inputs.MouseInput;
				var TouchInput = Samsara.Inputs.TouchInput;
				var GenericInput = Samsara.Inputs.GenericInput;
				var Accumulator = Samsara.Streams.Accumulator;
				var Differential = Samsara.Streams.Differential;
				
				GenericInput.register({
					 mouse : MouseInput,
					 touch : TouchInput,
				});
				
				var origSize = [200, 200];
				var side = null;
				var size = new Transitionable(origSize);
				
				var surface = new Surface({
						size: size,
				});
				surface.setContent(this.$.p);

				var handle = new GenericInput(['mouse', 'touch']);
				handle.subscribe(surface);
				
				var spring = new Transitionable();
				var springDelta = new Differential();
				springDelta.subscribe(spring);
				
				var position = new Accumulator([0,0]);
				position.subscribe(handle.pluck('delta'));
				position.subscribe(springDelta);
				
				var transform = position.map(function (value) {
					return Transform.translate(value);
				});
				
				var context = new Context();
				context
					.add({transform: Transform.translate([12, 12, 0]) })
					.add({size: [undefined, undefined], margins: [12, 12]})
					.add({transform: transform})
					.add(surface);
				context.mount(this.$.root);
				
				
				handle.on('start', function (data) {
					if(!side) return;

					if(side == 'bottom') this.$.p.minimized = false;
					side = null;

					size.set(origSize, {
						curve: 'spring', 
						damping: .7, 
						period: 80, 
						velocity : data.velocity
					});
				}.bind(this));
				
				var throwSpeed = 4;
				handle.on('end', function (data) {
					var vx = data.velocity[0],
							vy = data.velocity[1],
							vxa = Math.abs(vx),
							vya = Math.abs(vy),
							v = Math.max(vxa, vya);
							
					if(vxa == vya || Math.abs(v) < throwSpeed) return;
					
					if(v == vy)
						throwTo('bottom', [0, window.innerHeight - 2 * 12 - 52], [52, 52]);
					else if(v == -vy) 
						throwTo('top', [0, 0], [undefined, undefined]);
					else
						throwTo(v == vx ? 'right' : 'left', [v == vx ? window.innerWidth - 200 - 2 * 12 : 0, 0], [200, undefined]);
					
					function throwTo(s, pos, dim) {
						side = s;
						
						if (spring.isActive()) spring.halt();
						spring.reset(position.get());
						spring.set(pos, {
							curve: 'spring', 
							damping: .7, 
							period: 80, 
							velocity : data.velocity
						});
						
						if (size.isActive()) size.halt();
						size.set(dim, {
							curve: 'spring', 
							damping: .7, 
							period: 80, 
							velocity : data.velocity
						});
					}	
				});
				
				spring.on('end', function (data) {
					if(side == 'bottom') this.$.p.minimized = true;
				// // 	size.set([200, undefined]);
				}.bind(this));
      }
    }

    window.customElements.define(MainPage.is, MainPage);
  </script>
</dom-module>
